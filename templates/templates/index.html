<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goliath - Global Distributed Intelligence & Search</title>
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <!-- Bootstrap CSS Utilities -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/index.css">
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round" class="feather feather-zap"
                    style="color: var(--primary-color);">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                </svg>
                Goliath
            </h1>
        </div>
        <nav class="nav-links">
            <li class="nav-item">
                <a href="#dashboard-section" id="nav-dashboard" class="nav-link active">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" class="feather feather-grid">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Dashboard
                </a>
            </li>
            <li class="nav-item">
                <a href="#search-section" id="nav-search" class="nav-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" class="feather feather-search">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                    Search Engine
                </a>
            </li>
            <li class="nav-item">
                <a href="#crawler-section" id="nav-crawler" class="nav-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" class="feather feather-play-circle">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="10 8 16 12 10 16 10 8"></polyline>
                    </svg>
                    Crawler Control
                </a>
            </li>
            <li class="nav-item">
                <a href="#logs-section" id="nav-logs" class="nav-link">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round" class="feather feather-terminal">
                        <polyline points="4 17 10 11 4 5"></polyline>
                        <line x1="12" y1="19" x2="20" y2="19"></line>
                    </svg>
                    Live Logs
                </a>
            </li>
        </nav>
        <div class="sidebar-footer" style="padding-top: 2rem; border-top: 1px solid #1e293b;">
            <p style="font-size: 0.75rem; color: #64748b; font-weight: 500;">NETWORK VERSION v2.0.4<br>NODE CLUSTER:
                <span class="text-success" style="font-weight: 700;">STABLE</span></p>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">System Overview</h2>
                <p class="section-subtitle">Real-time health and throughput metrics from the global node cluster.</p>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-label">Queue Depth</div>
                    <div class="stat-value" id="queueSizeValue">0</div>
                    <div class="mt-3 small text-muted">Awaiting ingestion from discovery nodes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Crawled Nodes</div>
                    <div class="stat-value" id="completedUrlsValue">0</div>
                    <div class="mt-3 small text-muted">Knowledge objects successfully mapped</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Cluster Anomalies</div>
                    <div class="stat-value" id="failedUrlsValue">0</div>
                    <div class="mt-3 small text-muted">Blocked domains or endpoint timeouts</div>
                </div>
            </div>
        </section>

        <!-- Search Hub Section -->
        <section id="search-section">
            <div class="section-header">
                <h2 class="section-title">Goliath Search</h2>
                <p class="section-subtitle">Query the unified distributed knowledge index.</p>
            </div>

            <div class="search-hub">
                <div class="search-form-wrapper">
                    <form id="searchForm">
                        <div class="input-group-custom">
                            <select id="fieldSelect">
                                <option value="content">Content</option>
                                <option value="url">URL</option>
                            </select>
                            <input type="text" id="searchInput" placeholder="Search the universal web crawl..."
                                required>
                            <button type="submit" class="search-btn-custom">Retrieve</button>
                        </div>
                    </form>

                    <form id="urlCheckForm" class="mt-5">
                        <div style="max-width: 550px; margin: 0 auto; display: flex; gap: 0.75rem;">
                            <input type="url" id="urlInput" class="form-control"
                                style="border-radius: 100px; padding: 0.875rem 1.5rem; border: 1px solid var(--border-color); background: #f8fafc;"
                                placeholder="Verify node coverage via URL..." required>
                            <button type="submit" class="btn-outline-saas" style="padding: 0 2rem;">Verify</button>
                        </div>
                    </form>
                </div>

                <div id="searchResults" class="mt-5 text-start" style="max-width: 900px; margin: 5rem auto 0 auto;">
                    <!-- Result items injected here -->
                </div>
            </div>
        </section>

        <!-- Crawler Controls Section -->
        <section id="crawler-section">
            <div class="section-header">
                <h2 class="section-title">Crawler Control</h2>
                <p class="section-subtitle">Orchestrate the distributed crawling behavior and node parameters.</p>
            </div>

            <div class="card border-0 shadow-sm p-4"
                style="border-radius: 24px; border: 1px solid var(--border-color) !important;">
                <form id="crawlForm">
                    <div class="row g-4">
                        <div class="col-12">
                            <label class="form-label fw-bold small text-secondary">DISCOVERY SEED URLS
                                (Multiline)</label>
                            <textarea class="form-control bg-light border-0" id="urls" name="urls" rows="3" required
                                style="border-radius: 16px; padding: 1rem;">https://news.ycombinator.com</textarea>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-secondary">MAX DEPTH</label>
                            <input type="number" class="form-control bg-light border-0" id="depth" name="depth"
                                value="2" min="1" max="10" style="border-radius: 12px; padding: 0.75rem;">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-secondary">MAX PAGES</label>
                            <input type="number" class="form-control bg-light border-0" id="limit" name="limit"
                                value="100" min="1" max="1000" style="border-radius: 12px; padding: 0.75rem;">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-secondary">DELAY (S)</label>
                            <input type="number" class="form-control bg-light border-0" id="delay" name="delay"
                                value="1" min="0" step="0.1" style="border-radius: 12px; padding: 0.75rem;">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold small text-secondary">SCOPE (DOMAIN)</label>
                            <input type="text" class="form-control bg-light border-0" id="allowed_domains"
                                name="allowed_domains" placeholder="example.com"
                                style="border-radius: 12px; padding: 0.75rem;">
                        </div>
                        <div class="col-12 d-flex gap-3 pt-3">
                            <button type="submit" class="btn-primary-saas">Initialize Cluster Crawl</button>
                            <button type="button" id="stopCrawl" class="btn-outline-saas text-danger">Shutdown
                                Cluster</button>
                            <button type="button" id="retryFailed" class="btn-outline-saas text-primary">Resume
                                Failures</button>
                        </div>
                    </div>
                </form>
            </div>
        </section>

        <!-- Live Logs Section -->
        <section id="logs-section">
            <div class="section-header">
                <h2 class="section-title">Node Telemetry</h2>
                <p class="section-subtitle">Real-time debug and status stream from active crawler nodes.</p>
            </div>

            <div class="card border-0 shadow-lg" style="border-radius: 20px; overflow: hidden; background: #0f172a;">
                <div class="card-header border-0 d-flex justify-content-between align-items-center px-4 py-3"
                    style="background: #1e293b;">
                    <div class="d-flex align-items-center gap-2">
                        <div
                            style="width: 10px; height: 10px; border-radius: 50%; background: #10b981; box-shadow: 0 0 8px #10b981;">
                        </div>
                        <span class="text-white small fw-bold" style="letter-spacing: 0.05em;">LIVE STREAM</span>
                    </div>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm px-3 btn-outline-light active"
                            id="showAllLogs">ALL</button>
                        <button type="button" class="btn btn-sm px-3 btn-outline-light"
                            id="showMasterLogs">MASTER</button>
                        <button type="button" class="btn btn-sm px-3 btn-outline-light"
                            id="showCrawlerLogs">CRAWLER</button>
                        <button type="button" class="btn btn-sm px-3 btn-outline-light"
                            id="showIndexerLogs">INDEXER</button>
                        <button type="button" class="btn btn-sm px-3 btn-outline-warning ms-3 border-warning"
                            id="debugLogs">DIAGNOSTIC</button>
                    </div>
                </div>
                <div id="logsContainer" class="terminal-viewer">
                    <div class="text-muted" style="opacity: 0.4; font-size: 0.8rem; letter-spacing: 0.02em;">Goliath OS
                        System v2.0.4 - Initializing telemetry connection...</div>
                </div>
            </div>
        </section>
    </main>

    <!-- Notifications Container -->
    <div id="notifications"
        style="position: fixed; top: 1.5rem; right: 1.5rem; z-index: 2000; width: 400px; display: flex; flex-direction: column; gap: 0.75rem;">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // High-End Notification logic
            function showNotification(message, type = 'success') {
                const notificationsDiv = document.getElementById('notifications');
                const notification = document.createElement('div');
                const bgClass = type === 'success' ? 'bg-white' : (type === 'danger' ? 'bg-danger text-white' : 'bg-warning');
                const borderClass = type === 'success' ? 'border-primary' : '';

                notification.className = `alert shadow-xl ${bgClass} p-4 fade show border-0 d-flex align-items-start gap-3`;
                notification.style.borderRadius = "16px";
                notification.style.borderLeft = type === 'success' ? "6px solid var(--primary-color)" : "6px solid transparent";

                notification.innerHTML = `
                    <div class="flex-grow-1">
                        <div class="fw-bold mb-1 small uppercase" style="letter-spacing: 0.1em; opacity: 0.8;">System ${type.toUpperCase()}</div>
                        <div style="font-size: 0.95rem;">${message}</div>
                    </div>
                    <button type="button" class="btn-close ${type === 'danger' ? 'btn-close-white' : ''}" data-bs-dismiss="alert"></button>
                `;
                notificationsDiv.appendChild(notification);
                setTimeout(() => { if (notification.parentNode) notification.parentNode.removeChild(notification); }, 6000);
            }

            // Scroll-Spy & Active Link logic via IntersectionObserver
            const sections = document.querySelectorAll('section');
            const navLinks = document.querySelectorAll('.nav-link');

            const observerOptions = {
                root: null,
                threshold: 0.3,
                rootMargin: "-10% 0px -70% 0px"
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.getAttribute('id');
                        navLinks.forEach(link => {
                            link.classList.remove('active');
                            if (link.getAttribute('href') === `#${id}`) {
                                link.classList.add('active');
                            }
                        });
                    }
                });
            }, observerOptions);

            sections.forEach(section => observer.observe(section));

            // Sticky Header scroll effect
            const headers = document.querySelectorAll('.section-header');
            window.addEventListener('scroll', () => {
                headers.forEach(header => {
                    const rect = header.getBoundingClientRect();
                    if (rect.top <= 5) {
                        header.classList.add('scrolled');
                    } else {
                        header.classList.remove('scrolled');
                    }
                });
            });

            // Smooth Scroll for Sidebar
            navLinks.forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    document.querySelector(this.getAttribute('href')).scrollIntoView({
                        behavior: 'smooth'
                    });
                });
            });

            // Update real-time status
            let statusFailCount = 0;
            function updateStatus() {
                fetch('/status')
                    .then(response => response.json())
                    .then(data => {
                        statusFailCount = 0;
                        if (!data.error) {
                            document.getElementById('queueSizeValue').textContent = data.queue_size || 0;
                            document.getElementById('completedUrlsValue').textContent = data.completed ? data.completed.length : 0;
                            document.getElementById('failedUrlsValue').textContent = data.failed ? data.failed.length : 0;
                        }
                    })
                    .catch(() => {
                        statusFailCount++;
                        if (statusFailCount > 5) console.warn("Node status link degraded.");
                    });
            }
            setInterval(updateStatus, 5000);
            updateStatus();

            // Form Handlers
            document.getElementById('crawlForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const formData = new FormData(this);
                const submitBtn = this.querySelector('button[type="submit"]');
                const orig = submitBtn.textContent;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>INITIALIZING DATA STREAM...';

                fetch('/start_crawl', { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                        submitBtn.disabled = false; submitBtn.textContent = orig;
                        if (data.status === 'success') {
                            showNotification('Global discovery nodes initialized successfully.', 'success');
                        } else {
                            showNotification(data.message, 'danger');
                        }
                        updateStatus();
                    })
                    .catch(err => {
                        submitBtn.disabled = false; submitBtn.textContent = orig;
                        showNotification('Network handshake failed: ' + err.message, 'danger');
                    });
            });

            // Search Hub Logic
            document.getElementById('searchForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const q = document.getElementById('searchInput').value;
                const f = document.getElementById('fieldSelect').value;
                if (!q) return;

                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary mb-3"></div>
                        <div class="text-muted fw-500">Scanning indexed node partitions...</div>
                    </div>
                `;

                const formData = new FormData();
                formData.append('query', q);
                formData.append('field', f);

                fetch('/search', { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            resultsDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                        } else if (data.length === 0) {
                            resultsDiv.innerHTML = '<div class="text-center py-5 text-muted h5">No knowledge matches found in current cluster index.</div>';
                        } else {
                            let html = `<h5 class="mb-5 text-secondary fw-800" style="letter-spacing: -0.01em;">TOP SEARCH RESULTS (${data.length} MATCHES)</h5>`;
                            data.forEach((res, i) => {
                                html += `
                                <div class="stat-card mb-4 border-0 shadow-sm" style="animation: fadeIn 0.4s ease-out forwards; animation-delay: ${i * 0.1}s;">
                                    <div class="d-flex justify-content-between align-items-start gap-4">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1 fw-bold fs-5" style="color: var(--primary-color);">${res.title || 'Untitled Node Data'}</h6>
                                            <div class="mb-2"><a href="${res.url}" target="_blank" class="text-secondary small text-decoration-none" style="opacity: 0.7; word-break: break-all;">${res.url}</a></div>
                                            <p class="text-muted small lh-lg" style="max-height: 3.5em; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${res.snippet || 'No metadata snippet available for this object.'}</p>
                                        </div>
                                        <div class="text-end" style="min-width: 80px;">
                                            <span class="badge rounded-pill px-3 py-2 bg-light text-primary border" style="font-weight:700;">${res.score.toFixed(2)}</span>
                                        </div>
                                    </div>
                                    <div class="mt-4 pt-3 border-top d-flex justify-content-between align-items-center" style="font-size: 0.75rem; color: #94a3b8; font-weight: 500;">
                                        <span>CLUSTER INDEX TIMESTAMP: ${res.timestamp || 'DATA_STALE'}</span>
                                        <span>REL: HIGH</span>
                                    </div>
                                </div>
                            `;
                            });
                            resultsDiv.innerHTML = html;
                        }
                    });
            });

            // Verify Coverage
            document.getElementById('urlCheckForm').addEventListener('submit', function (e) {
                e.preventDefault();
                const url = document.getElementById('urlInput').value;
                if (!url) return;
                const resultsDiv = document.getElementById('searchResults');
                resultsDiv.innerHTML = '<div class="text-center py-5"><div class="spinner-grow spinner-grow-sm text-secondary me-2"></div> VERIFYING INDEX COVERAGE...</div>';
                const formData = new FormData();
                formData.append('url', url);
                fetch('/check_url', { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                        const color = data.crawled === true ? 'primary' : (data.crawled === 'in_progress' ? 'warning' : 'secondary');
                        resultsDiv.innerHTML = `
                        <div class="alert bg-white border-${color} shadow-sm p-4 mt-4" style="border-radius: 16px; border-width: 2px !important; border: solid;">
                            <h6 class="fw-bold mb-2">Coverage Verification Result</h6>
                            <p class="mb-0 text-muted">${data.message}</p>
                            ${data.location ? `<div class="mt-2 small">NODE LOCATION: <span class="badge bg-light text-dark border">${data.location}</span></div>` : ''}
                        </div>
                    `;
                    });
            });

            // Shutdown/Resume
            document.getElementById('stopCrawl').addEventListener('click', function () {
                const btn = this; const orig = btn.textContent; btn.disabled = true; btn.textContent = 'EXECUTING SHUTDOWN...';
                fetch('/stop_crawl', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        btn.disabled = false; btn.textContent = orig;
                        showNotification(data.message, 'warning');
                        updateStatus();
                    });
            });

            document.getElementById('retryFailed').addEventListener('click', function () {
                const btn = this; const orig = btn.textContent; btn.disabled = true; btn.textContent = 'RE-TASKING NODES...';
                fetch('/retry_failed', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        btn.disabled = false; btn.textContent = orig;
                        showNotification(data.message, 'success');
                        updateStatus();
                    });
            });

            // Telemetry Streams
            let lastLogTimestamp = 0;
            function fetchLogs() {
                fetch('/get_logs?since=' + lastLogTimestamp)
                    .then(response => response.json())
                    .then(data => {
                        if (data.logs && data.logs.length > 0) {
                            const logsContainer = document.getElementById('logsContainer');
                            if (logsContainer.querySelector('.text-muted')) logsContainer.innerHTML = '';
                            const activeLogs = document.querySelector('.btn-group .active').id;
                            data.logs.forEach(log => {
                                if (log.timestamp > lastLogTimestamp) lastLogTimestamp = log.timestamp;
                                const logElement = document.createElement('div');
                                const logTypeClass = log.type.toLowerCase();
                                logElement.className = `log-entry log-${logTypeClass}`;
                                let isVisible = true;
                                if (activeLogs !== 'showAllLogs') {
                                    const filterType = activeLogs.replace('show', '').replace('Logs', '').toLowerCase();
                                    if (logTypeClass !== filterType) isVisible = false;
                                }
                                if (!isVisible) logElement.style.display = 'none';
                                logElement.textContent = `[${new Date(log.timestamp * 1000).toLocaleTimeString()}] ${log.message}`;
                                logsContainer.appendChild(logElement);
                            });
                            logsContainer.scrollTop = logsContainer.scrollHeight;
                        }
                    });
            }
            setInterval(fetchLogs, 2000);
            fetchLogs();

            // Telemetry Filters
            ['All', 'Master', 'Crawler', 'Indexer'].forEach(type => {
                document.getElementById('show' + type + 'Logs').addEventListener('click', function () {
                    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    if (type === 'All') {
                        document.querySelectorAll('.log-entry').forEach(e => e.style.display = '');
                    } else {
                        const t = type.toLowerCase();
                        document.querySelectorAll('.log-entry').forEach(e => {
                            e.style.display = e.classList.contains('log-' + t) ? '' : 'none';
                        });
                    }
                });
            });

            // Diagnostic Sequence
            document.getElementById('debugLogs').addEventListener('click', function () {
                const logsContainer = document.getElementById('logsContainer');
                logsContainer.innerHTML = '<div class="p-4 text-warning fw-mono">RUNNING SYSTEM DIAGNOSTICS... ACCESSING NODE PARTITIONS...</div>';
                fetch('/debug_logs')
                    .then(response => response.json())
                    .then(data => {
                        let html = '<div class="p-4"><h5 class="text-white mb-4">DIAGNOSTIC TRACE COMPLETE</h5>';
                        html += `<div class="mb-3 text-secondary">OS_PATH: ${data.working_directory}</div>`;
                        for (const [fn, info] of Object.entries(data.log_files)) {
                            const statusColor = info.exists ? '#10b981' : '#ef4444';
                            html += `
                                <div class="mb-3 p-3" style="background:rgba(255,255,255,0.03); border-radius:12px; border-left: 4px solid ${statusColor}">
                                    <div class="fw-bold">${fn.toUpperCase()}</div>
                                    <div class="small text-muted">${info.exists ? 'SYNC_ACTIVE' : 'NODES_UNREACHABLE'} | SIZE: ${info.size} BYTES</div>
                                </div>
                            `;
                        }
                        html += '</div>';
                        logsContainer.innerHTML = html;
                    });
            });
        });
    </script>
</body>

</html>